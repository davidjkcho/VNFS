%files
    /etc/passwd /etc
    /etc/shadow /etc
    /etc/group /etc
    /etc/gshadow /etc

%post
    # Variables
    export SLURM_VER=19.05.4
    export NHC_VER=1.4.2
    export KERNEL_OS=el8
    export KERNEL_ARCH=x86_64

    # Dependencies
    dnf -y install \
           munge \
           munge-devel \
           pam-devel

    # Slurm
    cd /tmp
    wget -c https://download.schedmd.com/slurm/slurm-${SLURM_VER}.tar.bz2

    # Patch for el8
    cat > slurm-el8.patch << EOF
--- slurm.spec.orig     2019-11-28 12:23:27.698838979 -0800
+++ slurm.spec  2019-11-28 12:26:12.474896829 -0800
@@ -62,7 +62,7 @@ Requires: munge
 %{?systemd_requires}
 BuildRequires: systemd
 BuildRequires: munge-devel munge-libs
-BuildRequires: python
+BuildRequires: python%{?el8:3}
 BuildRequires: readline-devel
 Obsoletes: slurm-lua slurm-munge slurm-plugins
 
@@ -158,7 +158,7 @@ BuildRequires: ucx-devel
 #
 # Should unpackaged files in a build root terminate a build?
 # Uncomment if needed again.
-#%define _unpackaged_files_terminate_build      0
+%define _unpackaged_files_terminate_build      0
 
 # Slurm may intentionally include empty manifest files, which will
 # cause errors with rpm 4.13 and on. Turn that check off.
EOF

    ln -s /bin/python3 /bin/python
    rpmbuild -ts --define "_topdir /tmp/rpmbuild" slurm-${SLURM_VER}.tar.bz2
    rpm -i --define "_topdir /tmp/rpmbuild" /tmp/rpmbuild/SRPMS/slurm-${SLURM_VER}-1.${KERNEL_OS}.src.rpm
    cat slurm-el8.patch | (cd /tmp/rpmbuild/SPECS ; patch -p0)
    rpmbuild -bb --define "_topdir /tmp/rpmbuild" --clean /tmp/rpmbuild/SPECS/slurm.spec
    dnf -y install \
           /tmp/rpmbuild/RPMS/${KERNEL_ARCH}/slurm-${SLURM_VER}-1.${KERNEL_OS}.${KERNEL_ARCH}.rpm \
           /tmp/rpmbuild/RPMS/${KERNEL_ARCH}/slurm-libpmi-${SLURM_VER}-1.${KERNEL_OS}.${KERNEL_ARCH}.rpm \
           /tmp/rpmbuild/RPMS/${KERNEL_ARCH}/slurm-pam_slurm-${SLURM_VER}-1.${KERNEL_OS}.${KERNEL_ARCH}.rpm \
           /tmp/rpmbuild/RPMS/${KERNEL_ARCH}/slurm-slurmd-${SLURM_VER}-1.${KERNEL_OS}.${KERNEL_ARCH}.rpm
    rm -rf /tmp/rpmbuild slurm-${SLURM_VER}.tar.bz2 slurm-el8.patch
    rm -f /bin/python
    systemctl enable munge
    systemctl enable slurmd
    mkdir -p /etc/slurm /var/spool/slurmd /var/log/munge /var/log/slurm
    chown slurm:slurm /etc/slurm
    chmod 755 /etc/slurm
    chown root:root /var/spool/slurmd
    chmod 755 /var/spool/slurmd
    chown munge:munge /var/log/munge
    chmod 700 /var/log/munge
    chown slurm:slurm /var/log/slurm
    chmod 755 /var/log/slurm

    # NHC
    cd /tmp
    wget -c https://github.com/mej/nhc/archive/${NHC_VER}.tar.gz -O nhc-${NHC_VER}.tar.gz
    tar zxpvf nhc-${NHC_VER}.tar.gz
    cd nhc-${NHC_VER}
    ./autogen.sh
    ./configure --prefix=/
    make install
    cd /tmp
    rm -rf nhc-${NHC_VER}.tar.gz nhc-${NHC_VER}

%post
    # Yum
    dnf clean all
    rm -rf /var/lib/yum/yumdb/*

    # Misc
    rm -f /etc/passwd /etc/passwd- /etc/shadow /etc/shadow- /etc/group /etc/group- /etc/gshadow /etc/gshadow-
